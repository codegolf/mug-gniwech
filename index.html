<canvas id="p" width="1024" height="512"></canvas>
<img hidden id="g" src="sprite.png">
<script type="text/javascript" src="./sound.js"></script>
<script>
	s = 0;
	ss = 0;
	poutres = [];
	coins = [];
	interruptors = [];
	xinit = [2,1];
	yinit = [14,2];
	xpos = xinit[0];
	ypos = yinit[0];
	lvl = 0;
	score = 0;
	// e=mur, f=porte, n=picd, k=picb, o=picg, j=pich, l=poutreV, m=poutreH g=coin, h=interE, i=interA,
	m = [[
		"eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee",
		"e k            e      e        e",
		"e              e   e  e       oe",
		"e              e   e           e",
		"e              e   eeeeee      e",
		"e          e   e    l   e      e",
		"e          e   eeeeeee  e      e",
		"e          e            e      e",
		"e          e      h     e      e",
		"e          e          eee      e",
		"e          e    e              e",
		"e          eeeeee              e",
		"e      j                       e",
		"e   eeee                       e",
		"en  e       j                 fe",
		"eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee"
		],[
		"                                ",
		"             e                  ",
		"             e                  ",
		" eeeee       e    l      e      ",
		"   e              l     fe      ",
		"                 gl   eeee      ",
		"                                ",
		"  e                             ",
		"  e                        e    ",
		"  e                       ge    ",
		"          eeeeeeeee        e    ",
		"   e            h e             ",
		"   eg       e                   ",
		"   eeeeeeeeee   ee              ",
		"                                ",
		"                                "
		]];
	for (i=0; i<m.length; ++i){
		poutres[i] = [];
		coins[i] = [];
		interruptors[i] = [];
		for (j=0; j<m[i].length; ++j){
			m[i][j] = m[i][j].split("");
			for(k=0;k<m[i][j].length;k++){
				if (m[i][j][k] == "l") poutres[i].push({x: k, y: j});
				if (m[i][j][k] == "g") coins[i].push({x: k, y: j});
				if (m[i][j][k] == "h") interruptors[i].push({x: k, y: j});
			}
		}
	}
	c = p.getContext('2d');
	d = function(x,y,num){
		c.drawImage(g,num*32,0,32,32,x*32,y*32,32,32);
	} // x=left in canvas, y=top in canvas, num = order of sprite
	onkeyup = function(e){
		e = e.keyCode;
		if(e==37 && s==0) s=4, ss=0; //left
		if(e==38 && s==0) s=2, ss=0; //up
		if(e==39 && s==0) s=3, ss=0; //right
		if(e==40 && s==0) s=1, ss=0; //down
	}

	a = function(xoffset,yoffset,state){
		if (m[lvl][ypos+yoffset] == undefined
			|| m[lvl][ypos+yoffset][xpos+xoffset] == undefined){
			s=0;
			ss = 0;
			for(i=0; i<coins[lvl].length; ++i){
				if (m[lvl][coins[lvl][i].y][coins[lvl][i].x] == " "){
					score--;
					m[lvl][coins[lvl][i].y][coins[lvl][i].x] = "g";
				}
			}
			for(i=0; i<interruptors[lvl].length; ++i){
				m[lvl][interruptors[lvl][i].y][interruptors[lvl][i].x] = "h";
			}
			for(i=0; i<poutres[lvl].length; ++i){
				m[lvl][poutres[lvl][i].y][poutres[lvl][i].x] = "l";
			}
			ypos = yinit[lvl];
			xpos = xinit[lvl];
			alert("you lost");
		}
		else if (m[lvl][ypos+yoffset][xpos+xoffset] == " "){ 
			ypos += yoffset; 
			xpos += xoffset; 
		}
		else if (m[lvl][ypos+yoffset][xpos+xoffset] == "f") {
			s=0;
			ss = 0;
			lvl++;
			ypos = yinit[lvl];
			xpos = xinit[lvl];
		}
		else if (m[lvl][ypos+yoffset][xpos+xoffset] == "g") {
			score++;
			m[lvl][ypos+yoffset][xpos+xoffset] = " ";
			ypos += yoffset; 
			xpos += xoffset; 
		}
		else if (m[lvl][ypos+yoffset][xpos+xoffset] == "h") {
			m[lvl][ypos+yoffset][xpos+xoffset] = "i";
			for(i=0; i<poutres[lvl].length; ++i){
				m[lvl][poutres[lvl][i].y][poutres[lvl][i].x] = " ";
			}
			ypos += yoffset; 
			xpos += xoffset; 
		}
		else if (m[lvl][ypos+yoffset][xpos+xoffset] == "i") {
			m[lvl][ypos+yoffset][xpos+xoffset] = "h";
			for(i=0; i<poutres[lvl].length; ++i){
				m[lvl][poutres[lvl][i].y][poutres[lvl][i].x] = "l";
			}
			ypos += yoffset; 
			xpos += xoffset;
		}
		else if (    m[lvl][ypos+yoffset][xpos+xoffset] != "e" 
				  && m[lvl][ypos+yoffset][xpos+xoffset] != "l" 
				  && m[lvl][ypos+yoffset][xpos+xoffset] != "m" )
		{ 
			s=0;
			ss = 0;
			for(i=0; i<coins[lvl].length; ++i){
				if (m[lvl][coins[lvl][i].y][coins[lvl][i].x] == " "){
					score--;
					m[lvl][coins[lvl][i].y][coins[lvl][i].x] = "g";
				}
			}
			for(i=0; i<interruptors[lvl].length; ++i){
				m[lvl][interruptors[lvl][i].y][interruptors[lvl][i].x] = "h";
			}
			for(i=0; i<poutres[lvl].length; ++i){
				m[lvl][poutres[lvl][i].y][poutres[lvl][i].x] = "l";
			}
			ypos = yinit[lvl];
			xpos = xinit[lvl]; 
			alert("you lost");
		} else {
			s=0;
			ss = state;
		}
	}
	var song={songData:[{i:[1,192,128,0,1,191,116,9,0,0,6,22,34,0,0,0,69,3,1,1,23,167,0,32,77,6,25,6],p:[1],c:[{n:[144,149,149,142,144,144,142,144,142,149,149,142,144,144,142,144,144,151,151,144,149,149,142,144,142,151,151,144,149,149,142,144],f:[]}]},{i:[2,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,195,6,1,2,135,0,0,32,147,6,121,6],p:[],c:[]},{i:[2,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,195,6,1,2,135,0,0,32,147,6,121,6],p:[],c:[]},{i:[2,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,195,6,1,2,135,0,0,32,147,6,121,6],p:[],c:[]},{i:[2,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,195,6,1,2,135,0,0,32,147,6,121,6],p:[],c:[]},{i:[2,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,195,6,1,2,135,0,0,32,147,6,121,6],p:[],c:[]},{i:[2,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,195,6,1,2,135,0,0,32,147,6,121,6],p:[],c:[]},{i:[2,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,195,6,1,2,135,0,0,32,147,6,121,6],p:[],c:[]}],rowLen:9450,patternLen:32,endPattern:2};
	var player = new CPlayer();
  	player.init(song);
  	var wave = player.createWave();
	var audio = document.createElement("audio");
	audio.src = URL.createObjectURL(new Blob([wave], {type: "audio/wav"}));
	audio.play();
	g.onload = function(){
		setInterval(function(){
			p.width = p.width;
			for(i=0;i<m[lvl].length;++i){
				for(j=0;j<m[lvl][i].length;++j){
					if(m[lvl][i][j] != " "){		
						d(j,i,m[lvl][i][j].charCodeAt(0)-96);
					}
				}
			}
			switch(s){
				case 0:
					break;
				case 1:
					a(0,1,1);
					break;
				case 2:
					a(0,-1,2);
					break;
				case 3:
					a(1,0,3);
					break;
				case 4:
					a(-1,0,4);
					break;
			}
			d(xpos,ypos,ss);
		},50);
	}

/** 
	Variables used :

 	a					=> move
	p 					=> div
	g    				=> img
	s 					=> state
	ss 					=> hero position
	xinit 				=> position initiale suivant x
	yinit 				=> position initiale suivant y
	xpos 				=> position courante suivant x
	ypos 				=> position courante suivant y
	m 					=> map
	c 					=> contexte du canvas
	d 					=> function de draw img
	lvl 				=> current level state
	poutres 			=> ensemble des éléments "poutre" des niveaux
**/
</script>
