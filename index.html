<canvas id="p" width="1024" height="512"></canvas>
<img hidden id="g" src="sprite.png">
<script>
	s = 0;
	ss = 0;
	poutres = [];
	xinit = [2,1];
	yinit = [14,2];
	xpos = xinit[0];
	ypos = yinit[0];
	lvl = 0;
	// e=mur, f=porte, n=picd, k=picb, o=picg, j=pich, l=poutreV, m=poutreH g=coin, h=interE, i=interA,
	m = [[
		"eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee",
		"e k            e      e        e",
		"e              e   e  e       oe",
		"e              e   e           e",
		"e              e   eeeeee      e",
		"e          e   e    l   e      e",
		"e          e   eeeeeee  e      e",
		"e          e            e      e",
		"e          e      h     e      e",
		"e          e          eee      e",
		"e          e    e              e",
		"e          eeeeee              e",
		"e      j                       e",
		"e   eeee                       e",
		"en  e       j                 fe",
		"eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee"
		],[
		"                                ",
		"             e                  ",
		"             e                  ",
		" eeeee       e    l      e      ",
		"   e              l     fe      ",
		"                 gl   eeee      ",
		"                                ",
		"  e           e                 ",
		"  e                        e    ",
		"  e                       ge    ",
		"          eeeeeeeee        e    ",
		"   e            h e             ",
		"   eg       e                   ",
		"   eeeeeeeeee   ee              ",
		"                                ",
		"                                "
		]];
	for (i=0; i<m.length; ++i){
		poutres[i] = [];
		for (j=0; j<m[i].length; ++j){
			m[i][j] = m[i][j].split("");
			for(k=0;k<m[i][j].length;k++){
				if (m[i][j][k] == "l") poutres[i].push({x: k, y: j});
			}
		}
	}
	c = p.getContext('2d');
	d = function(x,y,num){
		c.drawImage(g,num*32,0,32,32,x*32,y*32,32,32);
	} // x=left in canvas, y=top in canvas, num = order of sprite
	onkeyup = function(e){
		e = e.keyCode;
		if(e==37 && s==0) s=4, ss=0; //left
		if(e==38 && s==0) s=2, ss=0; //up
		if(e==39 && s==0) s=3, ss=0; //right
		if(e==40 && s==0) s=1, ss=0; //down
	}

	a = function(xoffset,yoffset,state){
		if (m[lvl][ypos+yoffset] == undefined
			|| m[lvl][ypos+yoffset][xpos+xoffset] == undefined){
			s=0;
			ss = 0;
			ypos = yinit[lvl];
			xpos = xinit[lvl];
			alert("you lost");
		}
		else if (m[lvl][ypos+yoffset][xpos+xoffset] == " "){ 
			ypos += yoffset; 
			xpos += xoffset; 
		}
		else if (m[lvl][ypos+yoffset][xpos+xoffset] == "f") {
			s=0;
			ss = 0;
			lvl++;
			ypos = yinit[lvl];
			xpos = xinit[lvl]; 
			alert("you win !");
		}
		else if (m[lvl][ypos+yoffset][xpos+xoffset] == "h") {
			m[lvl][ypos+yoffset][xpos+xoffset] = "i";
			for(i=0; i<poutres[lvl].length; ++i){
				m[lvl][poutres[lvl][i].y][poutres[lvl][i].x] = " ";
			}
			ypos += yoffset; 
			xpos += xoffset; 
		}
		else if (m[lvl][ypos+yoffset][xpos+xoffset] == "i") {
			m[lvl][ypos+yoffset][xpos+xoffset] = "h";
			for(i=0; i<poutres[lvl].length; ++i){
				m[lvl][poutres[lvl][i].y][poutres[lvl][i].x] = "l";
			}
			ypos += yoffset; 
			xpos += xoffset;
		}
		else if ( m[lvl][ypos+yoffset][xpos+xoffset] != "e" 
				&& m[lvl][ypos+yoffset][xpos+xoffset] != "l" 
				&& m[lvl][ypos+yoffset][xpos+xoffset] != "m"
				)
		{ 
			s=0;
			ss = 0;
			ypos = yinit[lvl];
			xpos = xinit[lvl]; 
			alert("you lost");
		} else {
			s=0;
			ss = state;
		}
	}

	g.onload = function(){
		setInterval(function(){
			p.width = p.width;
			for(i=0;i<m[lvl].length;++i){
				for(j=0;j<m[lvl][i].length;++j){
					if(m[lvl][i][j] != " "){		
						d(j,i,m[lvl][i][j].charCodeAt(0)-96);
					}
				}
			}
			switch(s){ //pas de victoire encore ( à améliorer bien sûr )
				case 0:
					break;
				case 1:
					a(0,1,1);
					break;
				case 2:
					a(0,-1,2);
					break;
				case 3:
					a(1,0,3);
					break;
				case 4:
					a(-1,0,4);
					break;
			}
			d(xpos,ypos,ss);
		},50);
	}

/** 
	Variables used :

	p 					=> div
	g    				=> img
	s 					=> state
	ss 					=> hero position
	xpos 				=> position initiale suivant x
	ypos 				=> position initiale suivant y
	m 					=> map
	c 					=> contexte du canvas
	d 					=> function de draw img
	lvl 				=> current level state
**/
</script>
